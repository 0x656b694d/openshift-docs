= MongoDB
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:

toc::[]

== Overview
OpenShift provides a Docker image for running MongoDB.  This image can provide
database services based on username, password, and database name settings
provided via configuration.

== Versions
Currently, OpenShift provides version
https://github.com/openshift/mongodb/tree/master/2.4[2.4] of MongoDB.

== Images

This image comes in two flavors, depending on your needs:

* RHEL 7
* CentOS 7

*RHEL 7 Based Image*

The RHEL 7 image is available through Red Hat's subscription registry via:

----
$ docker pull registry.access.redhat.com/openshift3/mongodb-24-rhel7
----

*CentOS 7 Based Image*

This image is available on DockerHub. To download it:

----
$ docker pull openshift/mongodb-24-centos7
----

To use these images, you can either access them directly from these
registries or push them into your OpenShift docker registry. Additionally,
you can create an ImageStream that points to the image,
either in your docker registry or at the external location. Your OpenShift
resources can then reference the ImageStream. You can find
https://github.com/openshift/origin/tree/master/examples/image-streams[example]
ImageStream definitions for all the provided OpenShift images.

== Configuration and Usage

=== Initializing the Database

The first time you use the shared volume, the database is created along with the
database administrator user. Afterwards, the MongoDB daemon starts up. If you
are re-attaching the volume to another container, then the database, database
user, and the administrator user are not created, and the MongoDB daemon starts.

This example will create a new database Pod with MongoDB running in a container:

----
$ oc new-app -e MONGODB_USER=<username>,MONGODB_PASSWORD=<password>,MONGODB_DATABASE=<database_name>,MONGODB_ADMIN_PASSWORD=<admin_password> openshift/mongodb-24-centos7
----


=== Running MongoDB Commands in Containers

OpenShift uses https://www.softwarecollections.org/[Software Collections] to
install and launch MongoDB. If you want to execute a MongoDB command inside of a
running container (for debugging), you must invoke it using bash, to make sure
the MongoDB collection is enabled, for example:

----
$ oc exec -ti -p <POD> -c <CONTAINER> /bin/bash -c mongo
----

To enter a container from the host:

----
$ oc exec -it -p <POD> -c <CONTAINER> /bin/bash
----

When you enter the container, the required software collection is automatically enabled.

=== Environment Variables

The MongoDB username, password, database name, and admin password must be
configured with the following environment variables:

.MongoDB Environment Variables
[cols="4a,6a",options="header"]
|===

|Variable name |Description

|`*MONGODB_USER*`
|User name for MongoDB account to be created.

|`*MONGODB_PASSWORD*`
|Password for the user account.

|`*MONGODB_DATABASE*`
|Database name.

|`*MONGODB_ADMIN_PASSWORD*`
|Password for the admin user.
|===

[WARNING]
====
You must specify the username, password, database name, and admin password.
If you do not specify all four, the Pod will fail to start and OpenShift
will continuously try to restart it.
====

[NOTE]
====
Admin user name is set to `admin` and you have to specify his password by
setting `MONGODB_ADMIN_PASSWORD` environment variable. This process is done
upon database initialization.
====

MongoDB settings can be configured with the following environment variables.

.Additional MongoDB Settings
[cols="3a,6a,1a",options="header"]
|===

|Variable name |Description |Default

|`*MONGODB_NOPREALLOC*`
|Disable data file preallocation.
|true

|`*MONGODB_SMALLFILES*`
|Set MongoDB to use a smaller default data file size.
|true

|`*MONGODB_QUIET*`
|Runs MongoDB in a quiet mode that attempts to limit the amount of output.
|true
|===

=== Volume Mount Points

The MongoDB image can be run with mounted volumes to enable persistent storage for the database:

* *_/var/lib/mongodb_* - This is the database directory where
MongoDB stores database files.

== Creating a Database Service from a Template

OpenShift provides a link:../../dev_guide/templates.html[template] to make creating a new database service easy.  The template provides parameter fields to define all the mandatory environment variables (user, password, database name, etc) with predefined defaults including auto-generation of password values.  It will also define both a link:../../dev_guide/deployments.html[DeploymentConfig] and a link:../../architecture/core_concepts/pods_and_services.html#services[Service].

The MongoDB templates should have been registered in the `openshift` project by the administrator during the link:../../admin_guide/install/first_steps.html[first steps] setup process.  There are two templates available: 

* `mongodb-ephemeral` is for development/testing purposes only because it uses ephemeral storage for the database content.  This means that if the database Pod is restarted for any reason, such as the Pod being moved to another node or the DeploymentConfig being updated and triggered a redeploy, all data will be lost.
* `mongodb-persistent` uses a persistent volume store for the database data which means the data will survive a Pod restart.  Using persistent volumes requires a persistent volume pool be defined in the OpenShift deployment.  Instructions for setting up the pool are located link:../../admin_guide/persistent_storage_nfs.html[here].


You can find instructions for instantiating templates by following these link:../../dev_guide/templates.html#creating-resources-from-a-template[instructions].

Once you have instantiated the service, you can copy the username, password, and database name environment variables into a DeploymentConfig for another component that intends to access the database.  That component can then access the database via the Service that was defined.
