// Module included in the following assemblies:
// serverless-metering.adoc

[id="datasources-metering-serverless_{context}"]
= Data sources for Knative Serving metering

The following data source examples show how Knative Serving can be configured for use with {product-title} metering.

[id="knative-service-cpu-usage-ds_{context}"]
== Data source for CPU usage in Knative Serving

This example data source provides the accumulated CPU seconds used per Knative service over the report time period:

.Example YAML
[source,yaml]
----
apiVersion: metering.openshift.io/v1
kind: ReportDataSource
metadata:
  name: knative-service-cpu-usage
spec:
  prometheusMetricsImporter:
    query: >
      sum
          by(namespace,
             label_serving_knative_dev_service,
             label_serving_knative_dev_revision)
          (
            label_replace(rate(container_cpu_usage_seconds_total{container!="POD",container!="",pod!=""}[1m]), "pod", "$1", "pod", "(.*)")
            *
            on(pod, namespace)
            group_left(label_serving_knative_dev_service, label_serving_knative_dev_revision)
            kube_pod_labels{label_serving_knative_dev_service!=""}
          )
----

[id="knative-service-memory-usage-ds_{context}"]
== Data source for memory usage in Knative Serving

This example data source provides the average memory consumption per Knative service over the report time period:

.Example YAML
[source,yaml]
----
apiVersion: metering.openshift.io/v1
kind: ReportDataSource
metadata:
  name: knative-service-memory-usage
spec:
  prometheusMetricsImporter:
    query: >
      sum
          by(namespace,
             label_serving_knative_dev_service,
             label_serving_knative_dev_revision)
          (
            label_replace(container_memory_usage_bytes{container!="POD", container!="",pod!=""}, "pod", "$1", "pod", "(.*)")
            *
            on(pod, namespace)
            group_left(label_serving_knative_dev_service, label_serving_knative_dev_revision)
            kube_pod_labels{label_serving_knative_dev_service!=""}
          )
----

[id="applying-datasources-knative_{context}"]
== Applying data sources for Knative Serving metering

.Procedure

* Apply the `ReportDataSources` resource as a `.yaml` file:
+
[source,terminal]
----
$ oc apply -f <datasource-name>.yaml
----
+
.Example command
[source,terminal]
----
$ oc apply -f knative-service-memory-usage.yaml
----
