////
dnsmasq configuration

This module included in the following assemblies:
* install_config/upgrading/manual_upgrades.adoc

////

. Configure dnsmasq: Because of the changes made in {product-title} 3.6, you must
perform the following steps to configure dnsmasq as part of the upgrade. See DNS
Changes under xref:../../release_notes/ocp_3_6_release_notes.adoc#ocp-36-notable-technical-changes[Notable Technical Changes]
in the {product-title} 3.6 Release Notes.

ifdef::openshift-enterprise[]
+
.. Download the following script:
+
----
# wget https://raw.githubusercontent.com/openshift/openshift-ansible/release-3.6/roles/openshift_node_dnsmasq/files/networkmanager/99-origin-dns.sh -O /etc/NetworkManager/dispatcher.d/99-origin-dns.sh
# chmod 755 /etc/NetworkManager/dispatcher.d/99-origin-dns.sh
----
+
This command downloads the *99-origin-dns.sh* script and copies the script to the *_/etc/NetworkManager/dispatcher.d/_* directory.
This script configures pods to use the node IP address as resolver. Using 127.0.0.1 inside a pod would fail.

endif::[]
+
.. Create two  *_node-dnsmasq.conf_*  node configuration files. One at the path
*_/etc/origin/node/node-dnsmasq.conf_* and another at the path
*_/etc/dnsmasq.d/node-dnsmasq.conf_*. Both these file should have identical content as following:
+
----
server=/in-addr.arpa/127.0.0.1
server=/cluster.local/127.0.0.1
----
+
Sample *_node-dnsmasq.conf_* files:
+
[source, bash]
----
$ cat /etc/dnsmasq.d/node-dnsmasq.conf
  server=/in-addr.arpa/127.0.0.1
  server=/cluster.local/127.0.0.1
$ cat /etc/origin/node/node-dnsmasq.conf
  server=/in-addr.arpa/127.0.0.1
  server=/cluster.local/127.0.0.1
----

.. Edit the *_/etc/dnsmasq.d/origin-dns.conf_* file as follows:
+
----
no-resolv
domain-needed
no-negcache
max-cache-ttl=1
enable-dbus
bind-interfaces
listen-address=<node_ip_address> <1>
----
<1> This is the IP address of the node host.
+
Sample *_origin-dns.conf_* file:
+
[source, bash]
----
$ cat /etc/dnsmasq.d/origin-dns.conf
  no-resolv
  domain-needed
  no-negcache
  max-cache-ttl=1
  enable-dbus
  bind-interfaces
  listen-address=192.0.2.34
----

.. Edit the *_/etc/dnsmasq.d/origin-upstream-dns.conf_* file as follows:
+
----
server=<upstream-dns-server-1>
server=<upstream-dns-server-2>
----
+
Sample *_origin-upstream-dns.conf_* file:
+
[source, bash]
----
$ cat /etc/dnsmasq.d/origin-upstream-dns.conf
  server=8.8.8.8
  server=9.9.9.9
----

.. Edit the *_/etc/origin/node/node-config.yaml_* as follows:
+
----
dnsBindAddress: 127.0.0.1:53
dnsRecursiveResolvConf: /etc/origin/node/resolv.conf
dnsDomain: cluster.local
dnsIP: <node_ip_address> <1>
----
<1> This is the IP address of the node host.
+
Sample *_node-config.yaml_* and *_resolv.conf_* files:
+
[source, bash]
----
$ cat /etc/origin/node/node-config.yaml
      ...
    dnsBindAddress: 127.0.0.1:53
    dnsRecursiveResolvConf: /etc/origin/node/resolv.conf
    dnsDomain: cluster.local
    dnsIP: 192.0.2.34
    dockerConfig:
      ...

$ cat /etc/origin/node/resolv.conf
  nameserver 8.8.8.8
  nameserver 9.9.9.9
----

ifdef::openshift-enterprise[]
.. Edit the master DNS configuration file to listen on port `8053`. This avoids conflicts on port `53` and opens port `8053` in the firewall.

.. Restart Network Manager:
+
----
# systemctl restart NetworkManager
----

.. Edit the *_/etc/origin/node/node-config.yaml_* file to set the `dnsIP` field to the IP address of this node.

endif::[]

ifdef::openshift-origin[]
.. Update the *_/etc/systemd/system/atomic-openshift-node.service_* node systemd unit file:
+
----
[Unit]
Description=OpenShift Node
After=docker.service
Wants=openvswitch.service
After=ovsdb-server.service
After=ovs-vswitchd.service
Wants=docker.service
Documentation=https://github.com/openshift/origin
Requires=dnsmasq.service
After=dnsmasq.service

[Service]
Type=notify
EnvironmentFile=/etc/sysconfig/atomic-openshift-node
Environment=GOTRACEBACK=crash
ExecStartPre=/usr/bin/cp /etc/origin/node/node-dnsmasq.conf /etc/dnsmasq.d/
ExecStartPre=/usr/bin/dbus-send --system --dest=uk.org.thekelleys.dnsmasq /uk/org/thekelleys/dnsmasq uk.org.thekelleys.SetDomainServers array:string:/in-addr.arpa/127.0.0.1,/cluster.local/127.0.0.1
ExecStopPost=/usr/bin/rm /etc/dnsmasq.d/node-dnsmasq.conf
ExecStopPost=/usr/bin/dbus-send --system --dest=uk.org.thekelleys.dnsmasq /uk/org/thekelleys/dnsmasq uk.org.thekelleys.SetDomainServers array:string:
ExecStart=/usr/bin/openshift start node --config=${CONFIG_FILE} $OPTIONS
LimitNOFILE=65536
LimitCORE=infinity
WorkingDirectory=/var/lib/origin/
SyslogIdentifier=atomic-openshift-node
Restart=always
RestartSec=5s
TimeoutStartSec=300
OOMScoreAdjust=-999

[Install]
WantedBy=multi-user.target
----
+
.. Reload systemd and restart node service.
+
----
# systemctl daemon-reload
# systemctl restart atomic-openshift-node dnsmaq
----

endif::[]
